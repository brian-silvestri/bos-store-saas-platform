<div class="space-y-4">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-semibold text-[var(--neutral-text)]">Product management</h1>
      <p class="text-sm text-[var(--neutral-muted)]">Manage your product catalog</p>
    </div>
    <div class="flex items-center gap-2">
      <button class="btn-primary" (click)="toggleForm()">
        {{ formOpen ? 'Close' : '+ New product' }}
      </button>
    </div>
  </div>

  <form
    *ngIf="formOpen"
    class="bg-[var(--surface)] border border-[var(--neutral-border)] rounded-xl p-4 shadow-sm space-y-3"
    (ngSubmit)="saveProduct()"
  >
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold text-[var(--neutral-text)]">
        {{ editingId ? 'Edit product' : 'New product' }}
      </h3>
      <button class="text-sm text-[var(--neutral-muted)] hover:text-[var(--primary)]" type="button" (click)="resetForm()">
        Limpiar
      </button>
    </div>

    <div class="grid md:grid-cols-2 gap-3 text-sm">
      <div class="flex flex-col gap-1">
        <label class="text-[var(--neutral-muted)]">Name *</label>
        <input
          class="border border-[var(--neutral-border)] rounded-lg px-3 py-2"
          name="productName"
          [(ngModel)]="form.name"
          required
        />
      </div>
      <div class="flex flex-col gap-1">
        <label class="text-[var(--neutral-muted)]">Price</label>
        <input
          class="border border-[var(--neutral-border)] rounded-lg px-3 py-2"
          name="productPrice"
          type="number"
          min="0"
          [(ngModel)]="form.price"
        />
      </div>
      <div class="flex flex-col gap-1">
        <label class="text-[var(--neutral-muted)]">Category</label>
        <select
          class="border border-[var(--neutral-border)] rounded-lg px-3 py-2 bg-[var(--surface)]"
          name="productCategory"
          [(ngModel)]="form.category"
        >
          <option value="">Uncategorized</option>
          <option *ngFor="let c of categories()" [value]="c">{{ c }}</option>
        </select>
      </div>
      <div class="flex flex-col gap-1">
        <label class="text-[var(--neutral-muted)]">Image</label>
        <div class="flex gap-2">
          <input
            type="file"
            accept="image/*"
            (change)="onFileSelected($event)"
            #fileInput
            class="hidden"
          />
          <button
            type="button"
            (click)="fileInput.click()"
            class="px-4 py-2 border border-[var(--neutral-border)] rounded-lg text-sm hover:bg-[var(--neutral-surface)] transition"
          >
            {{ form.imageUrl ? 'Change image' : 'Upload image' }}
          </button>
          <input
            class="flex-1 border border-[var(--neutral-border)] rounded-lg px-3 py-2 text-sm"
            name="productImage"
            [(ngModel)]="form.imageUrl"
            placeholder="Or paste image URL"
          />
        </div>
        @if (uploadingImage()) {
          <div class="text-xs text-[var(--secondary)]">Uploading...</div>
        }
        @if (form.imageUrl) {
          <div class="mt-2">
            <img [src]="getImageUrl(form.imageUrl)" alt="Preview" class="w-20 h-20 object-cover rounded-lg border border-[var(--neutral-border)]" />
          </div>
        }
      </div>
      <div class="md:col-span-2 flex flex-col gap-1">
        <label class="text-[var(--neutral-muted)]">Description</label>
        <textarea
          class="border border-[var(--neutral-border)] rounded-lg px-3 py-2"
          name="productDescription"
          rows="3"
          [(ngModel)]="form.description"
        ></textarea>
      </div>
      <label class="flex items-center gap-2 text-[var(--neutral-muted)]">
        <input type="checkbox" name="productPromo" [(ngModel)]="form.isPromotion" />
        On promotion
      </label>
    </div>

    <div class="flex items-center gap-3 pt-2">
      <button class="btn-primary" type="submit">
        {{ editingId ? 'Save changes' : 'Create product' }}
      </button>
      <button class="px-4 py-2 rounded-lg border border-[var(--neutral-border)] text-sm text-[var(--neutral-subtle)]" type="button" (click)="toggleForm()">
        Cancel
      </button>
    </div>
  </form>

  <div class="bg-[var(--surface)] border border-[var(--neutral-border)] rounded-xl shadow-sm">
    <div class="p-4 border-b border-[var(--neutral-border)] flex items-center">
      <input
        type="text"
        placeholder="Search products..."
        class="w-full border border-[var(--neutral-border)] rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--secondary)]"
        [(ngModel)]="search"
        name="searchProducts"
      />
    </div>

    <div class="overflow-auto">
      <table class="min-w-full text-sm text-[var(--neutral-text)]">
        <thead class="bg-[var(--neutral-surface)] text-xs text-[var(--neutral-muted)] border-b border-[var(--neutral-border)]">
          <tr>
            <th class="px-4 py-3 text-left">Product</th>
            <th class="px-4 py-3 text-left">SKU</th>
            <th class="px-4 py-3 text-left">Category</th>
            <th class="px-4 py-3 text-left">Price</th>
            <th class="px-4 py-3 text-left">Promo</th>
            <th class="px-4 py-3 text-left">Photo</th>
            <th class="px-4 py-3 text-left">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let p of filteredProducts()"
            class="border-b border-[var(--neutral-border)] hover:bg-[var(--neutral-surface)]"
          >
            <td class="px-4 py-3">{{ p.name }}</td>
            <td class="px-4 py-3 text-[var(--neutral-muted)]">{{ p.id }}</td>
            <td class="px-4 py-3 text-[var(--neutral-muted)]">{{ p.category }}</td>
            <td class="px-4 py-3 text-[var(--secondary)]">
              {{ p.price ? (storeCurrency + p.price) : 'N/D' }}
            </td>
            <td class="px-4 py-3 text-[var(--neutral-muted)]">{{ p.isPromotion ? 'Yes' : 'No' }}</td>
            <td class="px-4 py-3">
              <div class="w-12 h-12 rounded-lg overflow-hidden bg-[var(--neutral-surface-alt)] border border-[var(--neutral-border)]">
                <img
                  *ngIf="p.imageUrl"
                  [src]="getImageUrl(p.imageUrl)"
                  class="w-full h-full object-cover"
                  alt="{{ p.name }}"
                />
              </div>
            </td>
            <td class="px-4 py-3">
              <div class="flex gap-2">
                <button class="btn-outline px-3 py-1" (click)="editProduct(p)">Edit</button>
                <button class="btn-danger px-3 py-1" (click)="deleteProduct(p)">Delete</button>
              </div>
            </td>
          </tr>
          <tr *ngIf="filteredProducts().length === 0">
            <td colspan="7" class="px-4 py-6 text-center text-[var(--neutral-muted)]">
              No products to display.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

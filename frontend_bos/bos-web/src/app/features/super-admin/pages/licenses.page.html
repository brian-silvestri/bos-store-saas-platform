<div>
  <div class="mb-8 flex justify-between items-center">
    <div>
      <h1 class="text-3xl font-bold text-[var(--neutral-text)] mb-2">Gesti贸n de Licencias</h1>
      <p class="text-[var(--neutral-muted)]">Administra planes y c贸digos de licencia</p>
    </div>
    <div class="flex gap-3">
      <button
        (click)="openCreatePlanModal()"
        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors"
      >
        + Crear Plan
      </button>
      <button
        (click)="openGenerateCodeModal()"
        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors"
      >
        + Generar C贸digo
      </button>
    </div>
  </div>

  <!-- Plans Section -->
  <div class="bg-[var(--surface)] rounded-xl shadow-sm overflow-hidden mb-8">
    <div class="px-6 py-4 border-b border-[var(--neutral-border)]">
      <h2 class="text-xl font-semibold text-[var(--neutral-text)]">Planes Disponibles</h2>
    </div>

    @if (loading()) {
      <div class="p-12 text-center text-[var(--neutral-muted)]">Cargando...</div>
    } @else if (plans().length === 0) {
      <div class="p-12 text-center text-[var(--neutral-muted)]">No hay planes creados</div>
    } @else {
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-6">
        @for (plan of plans(); track trackById($index, plan)) {
          <div class="plan-card">
            <div class="flex justify-between items-start mb-3">
              <div>
                <h3 class="text-lg font-bold text-[var(--neutral-text)]">{{ plan.name }}</h3>
                <p class="text-sm text-[var(--neutral-muted)]">{{ plan.description }}</p>
              </div>
              @if (!plan.isActive) {
                <span class="status-badge status-inactive">Inactivo</span>
              }
            </div>

            <div class="mb-4">
              <div class="text-3xl font-bold text-[var(--neutral-text)]">
                {{ formatCurrency(plan.price) }}
              </div>
              <div class="text-sm text-[var(--neutral-muted)]">
                {{ plan.durationDays }} d铆as
              </div>
            </div>

            <div class="space-y-2 text-sm">
              <div class="flex items-center gap-2">
                <span class="text-[var(--neutral-muted)]">Usuarios:</span>
                <span class="font-medium text-[var(--neutral-text)]">{{ plan.maxUsers }}</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-[var(--neutral-muted)]">ID:</span>
                <code class="text-xs bg-[var(--neutral-surface)] px-2 py-1 rounded">{{ plan.id }}</code>
              </div>
            </div>
          </div>
        }
      </div>
    }
  </div>

  <!-- License Codes Section -->
  <div class="bg-[var(--surface)] rounded-xl shadow-sm overflow-hidden">
    <div class="px-6 py-4 border-b border-[var(--neutral-border)]">
      <h2 class="text-xl font-semibold text-[var(--neutral-text)]">C贸digos de Licencia</h2>
    </div>

    @if (loading()) {
      <div class="p-12 text-center text-[var(--neutral-muted)]">Cargando...</div>
    } @else if (licenseCodes().length === 0) {
      <div class="p-12 text-center text-[var(--neutral-muted)]">No hay c贸digos generados</div>
    } @else {
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="bg-[var(--neutral-surface)] border-b border-[var(--neutral-border)]">
              <th class="px-6 py-4 text-left text-xs font-semibold text-[var(--neutral-muted)] uppercase tracking-wider">C贸digo</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-[var(--neutral-muted)] uppercase tracking-wider">Plan</th>
              <th class="px-6 py-4 text-center text-xs font-semibold text-[var(--neutral-muted)] uppercase tracking-wider">Duraci贸n</th>
              <th class="px-6 py-4 text-center text-xs font-semibold text-[var(--neutral-muted)] uppercase tracking-wider">Estado</th>
              <th class="px-6 py-4 text-center text-xs font-semibold text-[var(--neutral-muted)] uppercase tracking-wider">Usado Por</th>
              <th class="px-6 py-4 text-center text-xs font-semibold text-[var(--neutral-muted)] uppercase tracking-wider">Expira</th>
              <th class="px-6 py-4 text-right text-xs font-semibold text-[var(--neutral-muted)] uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-[var(--neutral-border)]">
            @for (code of licenseCodes(); track trackById($index, code)) {
              <tr class="hover:bg-[var(--neutral-surface)] transition-colors">
                <td class="px-6 py-4">
                  <div class="flex items-center gap-2">
                    <code class="text-sm font-mono bg-[var(--neutral-surface)] px-2 py-1 rounded">{{ code.code }}</code>
                    <button
                      (click)="copyToClipboard(code.code)"
                      class="text-blue-600 hover:text-blue-700 text-xs"
                      title="Copiar"
                    >
                      
                    </button>
                  </div>
                </td>
                <td class="px-6 py-4">
                  <span class="text-sm font-medium text-[var(--neutral-text)]">{{ code.planId }}</span>
                </td>
                <td class="px-6 py-4 text-center">
                  <span class="text-sm text-[var(--neutral-text)]">{{ code.durationDays }} d铆as</span>
                </td>
                <td class="px-6 py-4 text-center">
                  @if (code.isUsed) {
                    <span class="status-badge status-inactive">Usado</span>
                  } @else if (code.isExpired) {
                    <span class="status-badge status-inactive">Expirado</span>
                  } @else {
                    <span class="status-badge status-active">Disponible</span>
                  }
                </td>
                <td class="px-6 py-4 text-center">
                  @if (code.usedByTenantId) {
                    <span class="text-xs text-[var(--neutral-muted)]">{{ code.usedByTenantId }}</span>
                  } @else {
                    <span class="text-xs text-[var(--neutral-muted)]">-</span>
                  }
                </td>
                <td class="px-6 py-4 text-center">
                  <span class="text-xs text-[var(--neutral-muted)]">{{ formatDate(code.expiresAt) }}</span>
                </td>
                <td class="px-6 py-4 text-right">
                  @if (!code.isUsed && !code.isExpired) {
                    <button
                      (click)="revokeCode(code.code)"
                      class="px-3 py-1 text-xs font-medium text-red-600 bg-red-50 hover:bg-red-100 rounded-md transition-colors"
                    >
                      Revocar
                    </button>
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>
</div>

<!-- Create Plan Modal -->
@if (showCreatePlanModal()) {
  <div class="modal-overlay" (click)="closeCreatePlanModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2 class="text-2xl font-bold text-[var(--neutral-text)] mb-6">Crear Nuevo Plan</h2>

      <form (ngSubmit)="createPlan()" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-[var(--neutral-text)] mb-1">ID del Plan</label>
          <input
            type="text"
            [(ngModel)]="newPlan.id"
            name="id"
            required
            class="w-full px-3 py-2 border border-[var(--neutral-border)] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="ej: pro"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-[var(--neutral-text)] mb-1">Nombre</label>
          <input
            type="text"
            [(ngModel)]="newPlan.name"
            name="name"
            required
            class="w-full px-3 py-2 border border-[var(--neutral-border)] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="ej: Profesional"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-[var(--neutral-text)] mb-1">Descripci贸n</label>
          <textarea
            [(ngModel)]="newPlan.description"
            name="description"
            required
            rows="2"
            class="w-full px-3 py-2 border border-[var(--neutral-border)] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="Descripci贸n del plan"
          ></textarea>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-[var(--neutral-text)] mb-1">Precio (USD)</label>
            <input
              type="number"
              [(ngModel)]="newPlan.price"
              name="price"
              required
              min="0"
              step="0.01"
              class="w-full px-3 py-2 border border-[var(--neutral-border)] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-[var(--neutral-text)] mb-1">Duraci贸n (d铆as)</label>
            <input
              type="number"
              [(ngModel)]="newPlan.durationDays"
              name="durationDays"
              required
              min="1"
              class="w-full px-3 py-2 border border-[var(--neutral-border)] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-[var(--neutral-text)] mb-1">M谩ximo de Usuarios</label>
          <input
            type="number"
            [(ngModel)]="newPlan.maxUsers"
            name="maxUsers"
            required
            min="1"
            class="w-full px-3 py-2 border border-[var(--neutral-border)] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>

        <div class="flex justify-end gap-3 mt-6">
          <button
            type="button"
            (click)="closeCreatePlanModal()"
            class="px-4 py-2 border border-[var(--neutral-border)] text-[var(--neutral-text)] rounded-lg hover:bg-[var(--neutral-surface)] transition-colors"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
          >
            Crear Plan
          </button>
        </div>
      </form>
    </div>
  </div>
}

<!-- Generate Code Modal -->
@if (showGenerateCodeModal()) {
  <div class="modal-overlay" (click)="closeGenerateCodeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2 class="text-2xl font-bold text-[var(--neutral-text)] mb-6">Generar C贸digo de Licencia</h2>

      <form (ngSubmit)="generateCode()" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-[var(--neutral-text)] mb-1">Plan</label>
          <select
            [(ngModel)]="generateCodeForm.planId"
            name="planId"
            required
            class="w-full px-3 py-2 border border-[var(--neutral-border)] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            @for (plan of plans(); track plan.id) {
              <option [value]="plan.id">{{ plan.name }} ({{ plan.durationDays }} d铆as)</option>
            }
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-[var(--neutral-text)] mb-1">
            Duraci贸n Personalizada (d铆as)
            <span class="text-xs text-[var(--neutral-muted)]">(opcional, usa la del plan por defecto)</span>
          </label>
          <input
            type="number"
            [(ngModel)]="generateCodeForm.durationDays"
            name="durationDays"
            min="1"
            class="w-full px-3 py-2 border border-[var(--neutral-border)] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="Dejar vac铆o para usar duraci贸n del plan"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-[var(--neutral-text)] mb-1">
            Expiraci贸n del C贸digo (d铆as)
          </label>
          <input
            type="number"
            [(ngModel)]="generateCodeForm.codeExpirationDays"
            name="codeExpirationDays"
            required
            min="1"
            class="w-full px-3 py-2 border border-[var(--neutral-border)] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
          <p class="text-xs text-[var(--neutral-muted)] mt-1">
            El c贸digo expirar谩 en {{ generateCodeForm.codeExpirationDays }} d铆as si no se usa
          </p>
        </div>

        <div class="flex justify-end gap-3 mt-6">
          <button
            type="button"
            (click)="closeGenerateCodeModal()"
            class="px-4 py-2 border border-[var(--neutral-border)] text-[var(--neutral-text)] rounded-lg hover:bg-[var(--neutral-surface)] transition-colors"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors"
          >
            Generar C贸digo
          </button>
        </div>
      </form>
    </div>
  </div>
}
